@page "/newentry"
@rendermode InteractiveServer
<PageTitle>New Entry</PageTitle>



<h1 style="color: #eb3a9b; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:35px; font-weight: bold; padding-top: 10px; text-align: left;">Add New Entry</h1>
<input type="date" style="width: 20%; padding: 5px; border: 1px solid #eb3a9b; border-radius: 5px;">
<div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: center; width: 100%; box-sizing: border-box; margin-top: 20px;">
    <!-- Column Titles -->
    <h3 style="margin: 0; text-align: center; color: #eb3a9b;">Flowers</h3>
    <h3 style="margin: 0; text-align: center; color: #eb3a9b;">Units</h3>
    <h3 style="margin: 0; text-align: center; color: #eb3a9b;">Cost</h3>
    <h5 style="margin: 0; text-align: center; color: #eb3a9b;">Stem Cost</h5>
    <h5 style="margin: 0; text-align: center; color: #eb3a9b;">Change Since Last Entry</h5>
</div>

<div>
    @foreach (var row in rows)
    {
        <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: center; width: 100%; box-sizing: border-box; margin-top: 10px;">
            <select style="width: 90%; padding: 5px; border: 1px solid #eb3a9b; border-radius: 5px;" @bind="row.SelectedFlower">
                <option value="">Select a flower</option>
                @foreach (var flower in getFlowerOptions())
                {
                    <option value="@flower">@flower</option>
                }
            </select>

            <input type="number" placeholder="Units" style="width: 70%; padding: 5px; border: 1px solid #eb3a9b; border-radius: 5px;" @bind="row.Units">
            <input type="number" placeholder="Cost" style="width: 70%; padding: 5px; border: 1px solid #eb3a9b; border-radius: 5px;" @bind="row.Cost">
            <h6 style="text-align: center; color: #eb3a9b; margin: 0;">@row.StemCost.ToString("0.00")</h6>
            <h6 style="text-align: center; color: #eb3a9b; margin: 0;">@row.ChangeSinceLastEntry.ToString("0%")</h6>
        </div>
    }
</div>

<!-- New Line Button -->
<div style="text-align: left;">
    <button style="background-color: #eb3a9b; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; margin:10px; margin-top:20px;" @onclick="AddNewRow">New Line</button>
</div>

<!-- Save Button -->
<div style="text-align: left;">
    <button style="background-color: #eb3a9b; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; margin:10px;" @onclick="SaveEntries">Save</button>
</div>

@code{
  public string selectedFlower { get; set; }
  public string test { get; set; } = "";

  public string GrabFromData(string data, string[] tags)//Works
    {
        string currentData = data;

        foreach (string tag in tags)
        {
            int start = currentData.IndexOf("<" + tag + ">");
            int end = currentData.IndexOf("</" + tag + ">");

            if (start == -1 || end == -1)
                return "Not Found";

            currentData = currentData.Substring(start + tag.Length + 2, end - (start + tag.Length + 2));
        }
        
        return currentData;
    }
  public string ReadTxt()
    {
         List<string[]> csvData2 = new List<string[]>();
        //change this as needed
        string filePath = "C:\\Users\\efren\\OneDrive\\Desktop\\FlowerProjectData.txt";
        //change this

        using (StreamReader reader = new StreamReader(filePath)){
                string line;
                while ((line = reader.ReadLine()) != null){
                    string[] fields = line.Split(',');
                    csvData2.Add(fields);
                }
            }

        foreach (var row in csvData2)
        {
            return string.Join(",", row) + "\n";
        }
        return "";
    }

 public List<string> GetAllFlowers(string data)//works
    {

        int startIndex2 = data.IndexOf("<Flower>");
        int endIndex2 = data.IndexOf("</Flower>") + "</Flower>".Length; // End after </Object>
        string usingData = data;
        
    
        usingData = data.Substring(startIndex2, endIndex2 - startIndex2);

        List<string> flowerNames = new List<string>();
        int startIndex = 0;
        
        while ((startIndex = usingData.IndexOf("<", startIndex)) != -1)
        {
            int endIndex = usingData.IndexOf(">", startIndex);
            if (endIndex == -1) break;

            string tag = usingData.Substring(startIndex + 1, endIndex - startIndex - 1);
            
            if (!tag.Contains("/") && !tag.Contains("Price") && !tag.Contains("Amount") && !tag.Contains("Purchases") && !tag.Contains("Purchase") && !tag.Contains("Date")&& !tag.Contains("Type") && !tag.Contains("Flower"))
            {
                flowerNames.Add(tag);
            }
            startIndex = endIndex + 1;
        }

        return flowerNames;
    }
public string[] getFlowerOptions(){
        string[] returnThis = new string[] {};
        try{
         returnThis = GetAllFlowers(ReadTxt()).ToArray();
        }
        catch (Exception ex){
            returnThis = new string[] {"Option1", "Option2","option3"};
        }
        return returnThis;
    }

private void HandleChange(ChangeEventArgs e)
    {
        selectedFlower = e.Value.ToString();
        StateHasChanged();
    }




}

@code {
    private List<EntryRow> rows = new List<EntryRow> { new EntryRow() };

    private void AddNewRow()
    {
        rows.Add(new EntryRow());
    }

    private void SaveEntries()
    {
        rows.Clear();
        rows.Add(new EntryRow());
    }

    private IEnumerable<string> getsFlowerOptions()
    {
        return new List<string> { "Rose", "Tulip", "Lily", "Daisy" };
    }

    private class EntryRow
    {
        public string? SelectedFlower { get; set; }
        public int? Units { get; set; }
        public decimal? Cost { get; set; }
        public decimal StemCost => Units.HasValue && Cost.HasValue ? Cost.Value / Units.Value : 0;
        public decimal ChangeSinceLastEntry => 0; // Placeholder for actual calculation
    }
}